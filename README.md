[grafana_screenshot](https://github.com/homegrow-csc/pm2k-bis/blob/main/presentation/grafana-screenshot2025.png?raw=true)

# plantmaster2000
[ESPHome](https://esphome.io/) / [MQTT](https://mosquitto.org/) / [Grafana](https://grafana.com/) / [MariaDB](https://mariadb.org/) / [Python](https://www.python.org/) based environment for documenting plants in various stages of growth. If you have [3](https://www.bundesgesundheitsministerium.de/en/themen/cannabis/faq-cannabis-act.html#c29864) of them, for example.

Idea is that this setup should be controllable / integrateable with Homeassistant as well, which might suite some deployments better than the standalone approach.

This repository is the standalone approach. These scripts does not require a homeassistant installation and the sensor information is published to InfluxDB 2.

## Base Principle
* Images are stored in a single straight table in MariaDB, as base64 encoded jpegs. temperature, light intensity, humidity and other environmental data can also be stored.
* ESP32-CAM(s) running ESPHome code, sleeping and waking up for 2 minutes. While being awake, a control program contacts the camera and gets a picture using aioesphomeapi. Control program uploads to DB (after deciding to do so, based on light levels).
* Raspberry pi zero W with camera(s) running standard Raspberry Pi OS, taking pictures and uploading them to the database directly, using a python script. The same light level decision as for the ESP32CAMs is used. The SD card is read only, by the standard Raspberry Pi OS tools.
* ESP32 running Arduino code, collecting I2C + Dallas 1-Wire Sensor information and uploading it to InfluxDB 2. This can be temperature, humidity, brightness/light intensity, or other sensors.
* ESP32 running Arduino code, listening to MQTT events, opening and closing a MOSFET switch, which start and stop 12 computer case fans.
* ESP32 running Arduino code, publishing HX711 load cell data from a scale into Influx 2.
* Python (aioesphomeapi) script listening for MQTT messages from cameras waking up, evaluating light levels (from Influx) connecting and uploading image (from camera) and current sensor states (from Influx) into MariaDB
* Python script generating & publishing a random number to MQTT. This number is interpreted by an ESP32 as the desired state of a MOSFET switch, which in turn control fans.

## Presentation
* PHP scripts presenting images from MariaDB
* Grafana dashboard presenting data from Influx, with iframes to the PHP scripts mentioned above

## Timelapse Principle
* PHP exporting images from MariaDB to local storage, encoding environment information from MariaDB in the filenames, in JPEG format
* Python script graphically adding environment information to the locally stored images
* [FFMPEG](https://github.com/FFmpeg/FFmpeg) is used to generate a [dash.js](https://github.com/Dash-Industry-Forum/dash.js) video representation. Surrounding HTML generated by bash, cat & sed

# Using
* clone repo
* based on secrets-template.yaml and config-template.py, create the files secrets.yaml (for ESPHome) and config.py (for Python)
* based on camera1.yaml/camera2.yaml create the config for the camera(s)
* (create venv, figure out python dependencies and solving them with pip etc)
* install esphome, browse over the esphome docs 
* ```esphome compile camera1.yaml, esphome upload camera1.yaml``` or if you wish ```esphome run camera1.yaml``` and your camera(s) are complete
* ```esphome compile plantmaster2k-sensor.yaml, esphome upload plantmaster2k-sensor.yaml``` or if you wish ```esphome run plantmaster2k-sensor.yaml``` and your sensor node is complete (1 sensor node per 3 or 4 plants is needed)
* ```python esphome-plants.py``` which will connect to influx and the central node. It subscribes to the ESPHome sensors and uploads the results to an Influx bucket
* ```python cam-mqtt-trigger.py``` which connects to MariaDB, MQTT and influx. It connects directly to cameras when they wake up (knowing when by snooping on MQTT wakeup messages), asks for an image and uploads it to the MariaDB DB.

# Step by Step:

* To be defined, image

# Info
* This code is probably only usable if it is inspected and modified to your specific use case.
* Much information in the config file is only to tag the measurements in the database properly, for the code itself it does not matter what type of sensor it is or the name of it.
* It can probably be made to work with influx 1 by someone knowing how to do that.
* you might need to press CTRL-C several times to stop some of the python script, due to the async and kind of threaded code
* you can change the name of the sensor from double, triplewhammy etc. it has no meaning or sense.
* the only integration between the two python programs is through the sensor names in the config file. There is no pipe or tempfile or similar, the python scripts doesn't know about eachother.
* if the MQTT server is restarted or become unreachable, you need to restart the whole thing. That is why the scripts have a limited run length and restart after x iterations.
* if the cameras are located within a grow tent, you might need to move the AP a lot closer since the reflection material also seems to shield off radio waves.


# TODO
* documentation / fritzing etc
* polishing
* example grafana dashboard
